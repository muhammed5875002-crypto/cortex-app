{% extends "layout.html" %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="toast" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; 
         background: {{ '#0A84FF' if messages[0][0] == 'info' else '#30D158' }}; 
         padding: 12px 24px; border-radius: 25px; color: white; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
      {{ messages[0][1] }}
    </div>
    <script>setTimeout(() => document.getElementById('toast').remove(), 2500);</script>
  {% endif %}
{% endwith %}

<div class="ios-card" style="display: flex; justify-content: space-between; padding: 15px; margin-bottom: 20px;">
    {% for day in calendar %}
    <div style="display: flex; flex-direction: column; align-items: center; gap: 6px;">
        <div style="width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: {{ 'var(--success)' if day.active else 'rgba(255,255,255,0.05)' }};
            color: {{ 'black' if day.active else 'transparent' }}; border: {{ '1px solid #333' if not day.active else 'none' }};">
            {% if day.active %}<i class="fas fa-check" style="font-size: 12px;"></i>{% endif %}
        </div>
        <span style="font-size: 10px; color: {{ 'white' if day.is_today else 'var(--text-sec)' }}; font-weight: {{ 'bold' if day.is_today else 'normal' }};">{{ day.day }}</span>
    </div>
    {% endfor %}
</div>

<h4 style="margin: 0 0 10px 0; font-size: 18px;">Antrenman Kaydet</h4>
<div class="ios-card">
    <form method="POST">
        <input type="hidden" name="add_workout" value="1">
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <div style="flex: 1;">
                <label class="small-label">Tip</label>
                <select name="bolge" id="typeSelect" onchange="toggleForm('add')" style="width: 100%;">
                    <optgroup label="Güç">
                        <option value="Göğüs">Göğüs</option><option value="Sırt">Sırt</option>
                        <option value="Bacak">Bacak</option><option value="Omuz">Omuz</option>
                        <option value="Kol">Kol</option><option value="Karın">Karın</option>
                    </optgroup>
                    <optgroup label="Kardiyo">
                        <option value="Kardiyo">Kardiyo</option>
                    </optgroup>
                </select>
            </div>
            <div style="flex: 2;">
                <label class="small-label">Hareket</label>
                <input type="text" name="hareket" placeholder="Örn: Bench Press" required>
            </div>
        </div>

        <div id="add_strength" style="display: flex; gap: 10px; align-items: flex-end;">
            <div style="flex: 1;"><label class="small-label">Set</label><input type="number" name="sets" placeholder="4"></div>
            <div style="flex: 1;"><label class="small-label">Tekrar</label><input type="number" name="tekrar" placeholder="12"></div>
            <div style="flex: 1;"><label class="small-label">Kg</label><input type="number" name="agirlik" placeholder="60" step="0.5"></div>
            <button type="submit" class="btn-primary" style="width: 50px; height: 44px; border-radius: 10px;"><i class="fas fa-plus"></i></button>
        </div>

        <div id="add_cardio" style="display: none; gap: 10px; align-items: flex-end;">
            <div style="flex: 1;"><label class="small-label">Süre (Dk)</label><input type="number" name="sure" placeholder="30"></div>
            <div style="flex: 1;"><label class="small-label">Mesafe (Km)</label><input type="number" name="mesafe" placeholder="5" step="0.1"></div>
            <div style="flex: 1;"></div>
            <button type="submit" class="btn-primary" style="width: 50px; height: 44px; border-radius: 10px;"><i class="fas fa-plus"></i></button>
        </div>
    </form>
</div>

<h4 style="margin: 30px 0 10px 0; font-size: 18px;">Kür Takibi</h4>
<div class="ios-card">
    {% for sup in supplements %}
    <div class="check-row" style="display: flex; justify-content: space-between; align-items: center;">
        <form method="POST" style="margin:0; flex-grow: 1;">
            <input type="hidden" name="toggle_sup" value="1"><input type="hidden" name="sup_id" value="{{ sup.id }}">
            <button type="submit" style="background: none; border: none; width: 100%; text-align: left; display: flex; align-items: center; padding: 0;">
                <div style="width: 32px; height: 32px; background: {{ 'rgba(48, 209, 88, 0.2)' if sup.taken else 'rgba(255,255,255,0.1)' }}; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                    <i class="fas fa-pills" style="color: {{ '#30D158' if sup.taken else '#8E8E93' }};"></i>
                </div>
                <div><div style="font-weight: 600; color: {{ 'white' if sup.taken else '#8E8E93' }};">{{ sup.name }}</div><div style="font-size: 11px; color: var(--text-sec);">{{ sup.dozaj }}</div></div>
                <div style="margin-left: auto; margin-right: 15px;">{% if sup.taken %}<i class="fas fa-check-circle" style="color: var(--success); font-size: 18px;"></i>{% else %}<div style="width: 18px; height: 18px; border-radius: 50%; border: 2px solid #444;"></div>{% endif %}</div>
            </button>
        </form>
        <form method="POST" style="margin:0;"><input type="hidden" name="del_sup_def" value="1"><input type="hidden" name="sup_id" value="{{ sup.id }}"><button type="submit" style="background:none;border:none;color:#FF453A;opacity:0.6;padding:5px;"><i class="fas fa-trash-alt"></i></button></form>
    </div>
    {% endfor %}
    <div onclick="document.getElementById('supModal').style.display='flex'" style="padding: 12px 0; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); cursor: pointer; color: var(--primary); font-size: 13px; font-weight: 600;">+ Yeni Takviye</div>
</div>

<h4 style="margin: 30px 0 10px 0; font-size: 18px;">Hareket Geçmişi</h4>
{% for group in timeline %}
    <div style="margin-bottom: 20px;">
        <div style="font-size: 12px; color: var(--primary); font-weight: bold; margin-bottom: 5px; padding-left: 5px;">{{ group.date }}</div>
        <div class="ios-card" style="padding: 0;">
            {% for item in group.items %}
            <div style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
                
                <div>
                    <div style="font-weight: 600; font-size: 14px;">{{ item.hareket }}</div>
                    <div style="font-size: 11px; color: var(--text-sec);">
                        {% if item.bolge == 'Kardiyo' %}
                            <span style="color: #FF9F0A;">{{ item.sure }} dk</span> • {{ item.mesafe }} km
                        {% else %}
                            <span style="color: var(--success);">{{ item.agirlik }} kg</span> • {{ item.set_sayisi }} x {{ item.tekrar }}
                        {% endif %}
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" 
                        onclick="openEditModal('{{item.id}}', '{{item.bolge}}', '{{item.hareket}}', '{{item.set_sayisi}}', '{{item.tekrar}}', '{{item.agirlik}}', '{{item.sure}}', '{{item.mesafe}}')"
                        style="background:none; border:none; color: var(--primary); font-size: 14px; cursor: pointer;">
                        <i class="fas fa-pen"></i>
                    </button>

                    <form method="POST" style="margin:0;">
                        <input type="hidden" name="del_workout" value="1">
                        <input type="hidden" name="w_id" value="{{ item.id }}">
                        <button type="submit" style="background:none; border:none; color: #FF453A; font-size: 14px; cursor: pointer;"><i class="fas fa-trash"></i></button>
                    </form>
                </div>

            </div>
            {% endfor %}
        </div>
    </div>
{% else %}
    <div style="text-align: center; color: var(--text-sec); margin-top: 20px;">Henüz kayıt yok. Başlamak için yukarıdan ekle!</div>
{% endfor %}

<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center;">
    <div class="ios-card" style="width: 90%; max-width: 350px; background: #1c1c1e;">
        <h4 style="text-align: center; margin-top: 0;">Kaydı Düzenle</h4>
        <form method="POST">
            <input type="hidden" name="edit_workout" value="1">
            <input type="hidden" name="w_id" id="edit_id">
            
            <label class="small-label">Hareket</label>
            <input type="text" name="hareket" id="edit_hareket" required style="margin-bottom: 10px;">

            <input type="hidden" name="bolge" id="edit_bolge_val">
            <div id="edit_type_display" style="font-size: 12px; color: var(--primary); margin-bottom: 10px; font-weight: bold;"></div>

            <div id="edit_strength" style="display: none; gap: 5px;">
                <div><label class="small-label">Set</label><input type="number" name="sets" id="edit_sets"></div>
                <div><label class="small-label">Tekrar</label><input type="number" name="tekrar" id="edit_tekrar"></div>
                <div><label class="small-label">Kg</label><input type="number" name="agirlik" id="edit_agirlik" step="0.5"></div>
            </div>

            <div id="edit_cardio" style="display: none; gap: 5px;">
                <div><label class="small-label">Süre</label><input type="number" name="sure" id="edit_sure"></div>
                <div><label class="small-label">Mesafe</label><input type="number" name="mesafe" id="edit_mesafe" step="0.1"></div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" onclick="document.getElementById('editModal').style.display='none'" class="btn" style="background:#333;color:white;">İptal</button>
                <button type="submit" class="btn btn-primary">Güncelle</button>
            </div>
        </form>
    </div>
</div>

<div id="supModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div class="ios-card" style="width: 80%; max-width: 300px; background: #1c1c1e;">
        <h4 style="text-align: center; margin-top: 0;">Takviye Ekle</h4>
        <form method="POST">
            <input type="hidden" name="add_sup_def" value="1">
            <label class="small-label">Ad</label><input type="text" name="name" required style="margin-bottom: 10px;">
            <label class="small-label">Dozaj</label><input type="text" name="dozaj" required style="margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;"><button type="button" onclick="document.getElementById('supModal').style.display='none'" class="btn" style="background:#333;color:white;">İptal</button><button type="submit" class="btn btn-primary">Ekle</button></div>
        </form>
    </div>
</div>

<style>.small-label { font-size: 10px; color: var(--text-sec); margin-left: 2px; margin-bottom: 4px; display: block; }</style>

<script>
    // EKLEME FORMU İÇİN
    function toggleForm(prefix) {
        // prefix 'add' ise ekleme formunu yönetir
        var select = document.getElementById('typeSelect');
        var strength = document.getElementById('add_strength');
        var cardio = document.getElementById('add_cardio');
        
        if(select.value === 'Kardiyo') {
            strength.style.display = 'none';
            cardio.style.display = 'flex';
        } else {
            strength.style.display = 'flex';
            cardio.style.display = 'none';
        }
    }

    // DÜZENLEME MODALI İÇİN
    function openEditModal(id, bolge, hareket, sets, tekrar, agirlik, sure, mesafe) {
        document.getElementById('editModal').style.display = 'flex';
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_hareket').value = hareket;
        document.getElementById('edit_bolge_val').value = bolge;
        document.getElementById('edit_type_display').innerText = bolge + " Düzenleniyor";

        var strDiv = document.getElementById('edit_strength');
        var carDiv = document.getElementById('edit_cardio');

        if(bolge === 'Kardiyo') {
            strDiv.style.display = 'none';
            carDiv.style.display = 'flex';
            document.getElementById('edit_sure').value = sure;
            document.getElementById('edit_mesafe').value = mesafe;
        } else {
            strDiv.style.display = 'flex';
            carDiv.style.display = 'none';
            document.getElementById('edit_sets').value = sets;
            document.getElementById('edit_tekrar').value = tekrar;
            document.getElementById('edit_agirlik').value = agirlik;
        }
    }
</script>

{% endblock %}