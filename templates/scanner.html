{% extends "layout.html" %}

{% block content %}

<div class="glass-card mb-3">
    <div class="input-group input-group-lg">
        <span class="input-group-text bg-transparent text-primary border-0"><i class="fas fa-search"></i></span>
        <input type="text" id="search-input" class="form-control bg-transparent border-0 text-white" placeholder="Ürün ara (örn: Nescafe)...">
        <button class="btn btn-outline-secondary border-0" type="button" onclick="toggleCamera()">
            <i class="fas fa-barcode"></i>
        </button>
    </div>
</div>

<div id="camera-wrapper" class="glass-card p-0 overflow-hidden mb-3" style="display:none; position: relative;">
    <div id="interactive" class="viewport" style="width: 100%; height: 250px;"></div>
    <button onclick="toggleCamera()" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" style="z-index: 999;">
        <i class="fas fa-times"></i>
    </button>
    <div class="text-center text-muted small py-1">Kamerayı barkoda tut (Işık önemli!)</div>
</div>

<div id="results-area">
    <div class="text-center text-secondary mt-5">
        <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
        <p>Ürün adı yaz veya barkod tara.</p>
    </div>
</div>

<div id="toast" class="position-fixed top-50 start-50 translate-middle badge bg-success p-3 fs-6 shadow-lg" style="display:none; z-index: 2000;">
    <i class="fas fa-check me-2"></i>Kopyalandı!
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
    const searchInput = document.getElementById('search-input');
    const resultsArea = document.getElementById('results-area');
    const cameraWrapper = document.getElementById('camera-wrapper');
    let debounceTimer;

    // --- 1. METİN ARAMA (Google Gibi) ---
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        
        if(query.length < 2) return;

        // Yazarken bekle, sunucuyu yorma
        debounceTimer = setTimeout(() => {
            performSearch(query, 'text');
        }, 600);
    });

    // --- 2. API SORGUSU VE LİSTELEME ---
    function performSearch(query, type) {
        resultsArea.innerHTML = '<div class="text-center text-primary mt-4"><div class="spinner-border" role="status"></div></div>';
        
        fetch(`/api_search?q=${query}&type=${type}`)
            .then(res => res.json())
            .then(data => {
                resultsArea.innerHTML = '';
                
                if(data.length === 0) {
                    resultsArea.innerHTML = '<div class="text-center text-muted mt-4">Sonuç bulunamadı.</div>';
                    return;
                }

                data.forEach(item => {
                    // Kart Oluştur
                    const card = document.createElement('div');
                    card.className = 'glass-card d-flex justify-content-between align-items-center mb-2 p-3';
                    card.style.cursor = 'pointer';
                    card.onclick = () => copyToClipboard(item);

                    // İçerik
                    card.innerHTML = `
                        <div>
                            <div class="fw-bold text-white">${item.name}</div>
                            <div class="small text-secondary">${item.brand}</div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-dark text-warning border border-secondary">${item.cal} kcal</span>
                            <div class="small text-muted mt-1" style="font-size: 0.7rem;">
                                P:${item.pro} Y:${item.fat} K:${item.carb}
                            </div>
                        </div>
                    `;
                    resultsArea.appendChild(card);
                });
            });
    }

    // --- 3. KOPYALAMA İŞLEMİ ---
    function copyToClipboard(item) {
        // FatSecret'a yapıştırılacak format: "Nescafe 2 kcal"
        const text = `${item.name} ${item.cal} kcal`;
        
        navigator.clipboard.writeText(text).then(() => {
            // Görsel Geri Bildirim
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 1500);
        });
    }

    // --- 4. BARKOD KAMERASI (Opsiyonel) ---
    let scannerRunning = false;

    function toggleCamera() {
        if(scannerRunning) {
            Quagga.stop();
            cameraWrapper.style.display = 'none';
            scannerRunning = false;
        } else {
            cameraWrapper.style.display = 'block';
            startScanner();
            scannerRunning = true;
        }
    }

    function startScanner() {
        Quagga.init({
            inputStream : {
                name : "Live", type : "LiveStream", target: document.querySelector('#interactive'),
                constraints: { facingMode: "environment" } // Arka Kamera
            },
            decoder : { readers : ["ean_reader"] }, // Sadece Barkod
            locate: true
        }, function(err) {
            if (err) { console.log(err); return; }
            Quagga.start();
        });

        Quagga.onDetected(function(result) {
            var code = result.codeResult.code;
            if(code && code.length > 7) {
                // Barkod bulununca kamerayı kapat ve ara
                toggleCamera();
                searchInput.value = code; // Barkodu kutuya yaz
                performSearch(code, 'barcode');
                
                // Titreşim
                try { navigator.vibrate(200); } catch(e){}
            }
        });
    }
</script>
{% endblock %}