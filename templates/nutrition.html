{% extends "layout.html" %}

{% block content %}
<div class="row mb-3">
    <div class="col-6">
        <div class="card text-center p-2">
            <small class="text-muted">Toplam Kalori</small>
            <h3 class="text-warning mb-0">{{ total_cal }}</h3>
        </div>
    </div>
    <div class="col-6">
        <div class="card text-center p-2">
            <small class="text-muted">Toplam Protein</small>
            <h3 class="text-info mb-0">{{ total_pro }}g</h3>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>üçΩÔ∏è YEMEK EKLE</span>
        <button id="btn-scan" class="btn btn-sm btn-outline-warning">
            <i class="fas fa-camera"></i> Barkod Oku
        </button>
    </div>
    <div class="card-body">
        
        <div id="reader-container" class="mb-3" style="display:none;">
            <div id="reader" style="width: 100%;"></div>
            <button id="btn-stop" class="btn btn-danger w-100 mt-2">Kamerayƒ± Kapat</button>
        </div>

        <form method="POST">
            <input type="hidden" name="yemek_ekle" value="1">
            
            <div class="input-group mb-2">
                <span class="input-group-text bg-dark text-white border-secondary"><i class="fas fa-barcode"></i></span>
                <input type="text" id="barcode" name="barcode" class="form-control" placeholder="Barkod No (Varsa)">
            </div>

            <div class="mb-2">
                <input type="text" id="isim" name="isim" class="form-control" placeholder="Yemek Adƒ± (√ñrn: Muz)" required>
            </div>
            
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <input type="number" id="kalori" name="kalori" class="form-control" placeholder="Kalori">
                </div>
                <div class="col-6">
                    <input type="number" id="protein" name="protein" class="form-control" placeholder="Protein (g)">
                </div>
            </div>

            <button type="submit" class="btn btn-success w-100">Listeye Ekle</button>
        </form>
    </div>
</div>

<div class="card mt-4">
    <ul class="list-group list-group-flush">
        {% for meal in meals %}
        <li class="list-group-item bg-transparent text-white border-secondary d-flex justify-content-between align-items-center">
            <div>
                <strong>{{ meal.isim }}</strong>
                <br>
                <small class="text-muted">{{ meal.kalori }} kcal | {{ meal.protein }}g Prot</small>
            </div>
            <form method="POST" style="display:inline;">
                <input type="hidden" name="yemek_sil" value="1">
                <input type="hidden" name="yemek_id" value="{{ meal.id }}">
                <button class="btn btn-sm btn-outline-danger border-0"><i class="fas fa-trash"></i></button>
            </form>
        </li>
        {% endfor %}
    </ul>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
    const scanButton = document.getElementById('btn-scan');
    const stopButton = document.getElementById('btn-stop');
    const container = document.getElementById('reader-container');
    const previewElement = document.getElementById('reader'); // Div'in i√ßi

    // Ses Efekti
    function bip() { try { window.navigator.vibrate(200); } catch(e){} }

    // Quagga Ba≈ülatma Ayarlarƒ±
    scanButton.onclick = () => {
        container.style.display = 'block';
        
        Quagga.init({
            inputStream : {
                name : "Live",
                type : "LiveStream",
                target: previewElement, // Kamerayƒ± buraya bas
                constraints: {
                    facingMode: "environment", // Arka Kamera
                    width: 640,
                    height: 480,
                    aspectRatio: {min: 1, max: 2}
                }
            },
            // BURASI √ñNEMLƒ∞: Sadece EAN (Market) barkodu arƒ±yoruz
            decoder : {
                readers : ["ean_reader"] 
            },
            // G√∂r√ºnt√º ƒ∞yile≈ütirme Ayarlarƒ±
            locate: true,
            locator: {
                patchSize: "medium",
                halfSample: true
            }
        }, function(err) {
            if (err) {
                console.log(err);
                alert("Kamera hatasƒ±: " + err);
                container.style.display = 'none';
                return;
            }
            Quagga.start();
        });
    };

    // BARKOD BULUNUNCA NE OLSUN?
    Quagga.onDetected(function(result) {
        var code = result.codeResult.code;
        
        // Hatalƒ± okumalarƒ± engellemek i√ßin basit kontrol
        // Market barkodlarƒ± genelde 8 veya 13 haneli olur
        if (code && code.length > 7) {
            bip();
            document.getElementById('barcode').value = code;
            
            // Kamerayƒ± hemen durdur
            stopCamera();

            // Backend'e sor
            fetch(`/get_barcode_data?code=${code}`)
                .then(response => response.json())
                .then(data => {
                    if(data.found) {
                        document.getElementById('isim').value = data.name;
                        document.getElementById('kalori').value = data.calories;
                        document.getElementById('protein').value = data.protein;
                        alert("‚úÖ Bulundu: " + data.name);
                    } else {
                        alert("‚ö†Ô∏è √úr√ºn: " + code + " veritabanƒ±nda yok. Elle girerseniz kaydederim.");
                    }
                });
        }
    });

    function stopCamera() {
        Quagga.stop();
        container.style.display = 'none';
    }
    stopButton.onclick = stopCamera;
    
    // Manuel Giri≈ü Tetikleyicisi
    document.getElementById('barcode').addEventListener('change', function() {
        let code = this.value;
        if(code.length > 3) {
             fetch(`/get_barcode_data?code=${code}`)
            .then(response => response.json())
            .then(data => {
                if(data.found) {
                    document.getElementById('isim').value = data.name;
                    document.getElementById('kalori').value = data.calories;
                    document.getElementById('protein').value = data.protein;
                }
            });
        }
    });
</script>
{% endblock %}