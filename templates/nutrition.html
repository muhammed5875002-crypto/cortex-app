{% extends "layout.html" %}

{% block content %}
<div class="row mb-3">
    <div class="col-6">
        <div class="card text-center p-2">
            <small class="text-muted">Toplam Kalori</small>
            <h3 class="text-warning mb-0">{{ total_cal }}</h3>
        </div>
    </div>
    <div class="col-6">
        <div class="card text-center p-2">
            <small class="text-muted">Toplam Protein</small>
            <h3 class="text-info mb-0">{{ total_pro }}g</h3>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>üçΩÔ∏è YEMEK EKLE</span>
        <button id="btn-scan" class="btn btn-sm btn-outline-warning">
            <i class="fas fa-camera"></i> Barkod Oku
        </button>
    </div>
    <div class="card-body">
        
        <div id="reader-container" class="mb-3" style="display:none;">
            <div id="reader" style="width: 100%;"></div>
            <button id="btn-stop" class="btn btn-danger w-100 mt-2">Kamerayƒ± Kapat</button>
        </div>

        <form method="POST">
            <input type="hidden" name="yemek_ekle" value="1">
            
            <div class="input-group mb-2">
                <span class="input-group-text bg-dark text-white border-secondary"><i class="fas fa-barcode"></i></span>
                <input type="text" id="barcode" name="barcode" class="form-control" placeholder="Barkod No (Varsa)">
            </div>

            <div class="mb-2">
                <input type="text" id="isim" name="isim" class="form-control" placeholder="Yemek Adƒ± (√ñrn: Muz)" required>
            </div>
            
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <input type="number" id="kalori" name="kalori" class="form-control" placeholder="Kalori">
                </div>
                <div class="col-6">
                    <input type="number" id="protein" name="protein" class="form-control" placeholder="Protein (g)">
                </div>
            </div>

            <button type="submit" class="btn btn-success w-100">Listeye Ekle</button>
        </form>
    </div>
</div>

<div class="card mt-4">
    <ul class="list-group list-group-flush">
        {% for meal in meals %}
        <li class="list-group-item bg-transparent text-white border-secondary d-flex justify-content-between align-items-center">
            <div>
                <strong>{{ meal.isim }}</strong>
                <br>
                <small class="text-muted">{{ meal.kalori }} kcal | {{ meal.protein }}g Prot</small>
            </div>
            <form method="POST" style="display:inline;">
                <input type="hidden" name="yemek_sil" value="1">
                <input type="hidden" name="yemek_id" value="{{ meal.id }}">
                <button class="btn btn-sm btn-outline-danger border-0"><i class="fas fa-trash"></i></button>
            </form>
        </li>
        {% endfor %}
    </ul>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    const html5QrCode = new Html5Qrcode("reader");
    const scanButton = document.getElementById('btn-scan');
    const stopButton = document.getElementById('btn-stop');
    const container = document.getElementById('reader-container');

    // Ba≈üarƒ±lƒ± Okuma
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        // Titre≈üim
        try { window.navigator.vibrate(200); } catch(e){}

        // Ses Efekti (Bip) - Dosya eklemediƒüimiz i√ßin √ßalƒ±≈ümayabilir ama kodda dursun
        // var audio = new Audio('bip.mp3'); audio.play();

        document.getElementById('barcode').value = decodedText;
        
        // Okuma ba≈üarƒ±lƒ±ysa hemen durdurma, kullanƒ±cƒ± g√∂rs√ºn.
        // Ama "Bulunuyor..." mesajƒ± verebiliriz.
        stopCamera(); 

        fetch(`/get_barcode_data?code=${decodedText}`)
            .then(response => response.json())
            .then(data => {
                if(data.found) {
                    document.getElementById('isim').value = data.name;
                    document.getElementById('kalori').value = data.calories;
                    document.getElementById('protein').value = data.protein;
                    alert("‚úÖ Bulundu: " + data.name);
                } else {
                    alert("‚ö†Ô∏è √úr√ºn yok. L√ºtfen bilgileri bir kez elle girin, hafƒ±zaya alacaƒüƒ±m.");
                }
            })
            .catch(err => alert("Hata: " + err));
    };

    // --- KRƒ∞Tƒ∞K AYARLAR (√á√∂z√ºn√ºrl√ºk Artƒ±rƒ±ldƒ±) ---
    const config = { 
        fps: 10, // Saniyede 10 kare tara
        qrbox: { width: 300, height: 150 }, // Geni≈ü dikd√∂rtgen (Barkoda uygun)
        aspectRatio: 1.0,
        // Deneysel √∂zellik: Telefonun kendi barkod motorunu kullanmaya zorla (Daha hƒ±zlƒ±dƒ±r)
        experimentalFeatures: {
            useBarCodeDetectorIfSupported: true
        }
    };

    // Kamera Ayarlarƒ± (Odaklama ve √á√∂z√ºn√ºrl√ºk)
    const cameraConfig = { 
        facingMode: "environment", // Arka Kamera
        focusMode: "continuous",   // S√ºrekli Odaklama (Destekleyen telefonlarda)
        width: { min: 640, ideal: 1280, max: 1920 }, // HD g√∂r√ºnt√º iste (Bulanƒ±klƒ±ƒüƒ± √∂nler)
        height: { min: 480, ideal: 720, max: 1080 }
    };

    scanButton.onclick = () => {
        container.style.display = 'block';
        
        html5QrCode.start(
            cameraConfig, 
            config, 
            qrCodeSuccessCallback
        ).catch(err => {
            console.error(err);
            // Hata detayƒ±nƒ± g√∂ster
            if(err.name == "NotAllowedError") alert("Kamera izni verilmedi!");
            else alert("Kamera Hatasƒ±: " + err);
            container.style.display = 'none';
        });
    };

    function stopCamera() {
        html5QrCode.stop().then(() => {
            container.style.display = 'none';
        }).catch(err => console.log("Durdurma hatasƒ± (√∂nemli deƒüil):", err));
    }
    stopButton.onclick = stopCamera;

    // Manuel Giri≈ü Dinleyici
    document.getElementById('barcode').addEventListener('change', function() {
        let code = this.value;
        if(code.length > 3) {
             fetch(`/get_barcode_data?code=${code}`)
            .then(response => response.json())
            .then(data => {
                if(data.found) {
                    document.getElementById('isim').value = data.name;
                    document.getElementById('kalori').value = data.calories;
                    document.getElementById('protein').value = data.protein;
                }
            });
        }
    });
</script>
{% endblock %}