{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card p-3">
            <h6 class="text-muted small">GÃœNLÃœK HEDEF (2500 kcal)</h6>
            <div class="progress mb-2" style="height: 15px; background-color: #333;">
                <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (totals.cal / 2500)*100 }}%">
                    {{ totals.cal }}
                </div>
            </div>
            <div class="d-flex justify-content-between text-center small">
                <span class="text-info">Pro: {{ totals.pro }}g</span>
                <span class="text-success">Karb: {{ totals.carb }}g</span>
                <span class="text-danger">YaÄŸ: {{ totals.fat }}g</span>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span class="text-primary fw-bold">ğŸ½ï¸ EKLE</span>
        <button id="btn-scan" class="btn btn-sm btn-outline-secondary text-white">
            <i class="fas fa-barcode text-warning"></i>
        </button>
    </div>
    <div class="card-body position-relative">
        
        <div id="reader-container" class="mb-3" style="display:none; border-radius:8px; overflow:hidden;">
            <div id="reader"></div>
            <button id="btn-stop" class="btn btn-danger w-100 mt-2 btn-sm">Kapat</button>
        </div>

        <form method="POST">
            <input type="hidden" name="yemek_ekle" value="1">
            
            <div class="mb-2 position-relative">
                <input type="text" id="isim" name="isim" class="form-control" placeholder="Ne yedin? (Ã–rn: Zeytin)" autocomplete="off" required>
                <div id="search-results" class="list-group position-absolute w-100" style="z-index: 1000; display:none;"></div>
            </div>

            <div id="gram-container" class="input-group mb-2" style="display:none;">
                <span class="input-group-text bg-secondary text-white">Miktar</span>
                <input type="number" id="gram" class="form-control" value="100">
                <span class="input-group-text bg-dark text-white">gr</span>
            </div>

            <input type="hidden" id="ref_cal" value="0">
            <input type="hidden" id="ref_pro" value="0">
            <input type="hidden" id="ref_carb" value="0">
            <input type="hidden" id="ref_fat" value="0">

            <div class="row g-2 mb-2">
                <div class="col-3"><input type="text" id="kalori" name="kalori" class="form-control form-control-sm bg-dark text-white border-0" readonly placeholder="Cal"></div>
                <div class="col-3"><input type="text" id="protein" name="protein" class="form-control form-control-sm bg-dark text-white border-0" readonly placeholder="Pro"></div>
                <div class="col-3"><input type="text" id="carbs" name="carbs" class="form-control form-control-sm bg-dark text-white border-0" readonly placeholder="Carb"></div>
                <div class="col-3"><input type="text" id="fat" name="fat" class="form-control form-control-sm bg-dark text-white border-0" readonly placeholder="YaÄŸ"></div>
            </div>

            <select name="category" class="form-select form-select-sm mb-3 bg-dark text-white border-secondary">
                <option value="KahvaltÄ±">â˜• KahvaltÄ±</option>
                <option value="Ã–ÄŸle YemeÄŸi">â˜€ï¸ Ã–ÄŸle</option>
                <option value="AkÅŸam YemeÄŸi">ğŸŒ™ AkÅŸam</option>
                <option value="AtÄ±ÅŸtÄ±rmalÄ±k" selected>ğŸª AtÄ±ÅŸtÄ±rmalÄ±k</option>
            </select>

            <button type="submit" class="btn btn-success w-100 fw-bold">KAYDET</button>
        </form>
    </div>
</div>

<div class="card">
    <ul class="list-group list-group-flush">
        {% for meal in meals %}
        <li class="list-group-item bg-transparent text-white border-secondary d-flex justify-content-between align-items-center py-2">
            <div>
                <span class="badge bg-secondary me-1" style="font-size:0.6rem">{{ meal.category[0] }}</span>
                <strong>{{ meal.isim }}</strong>
                <div class="small text-muted">
                    <span class="text-warning">{{ meal.kalori }}k</span>
                    <span class="text-info">P:{{ meal.protein }}</span>
                    <span class="text-success">C:{{ meal.carbs }}</span>
                </div>
            </div>
            <form method="POST" class="m-0"><input type="hidden" name="yemek_sil" value="1"><input type="hidden" name="yemek_id" value="{{ meal.id }}"><button class="btn btn-sm text-danger p-0"><i class="fas fa-times"></i></button></form>
        </li>
        {% endfor %}
    </ul>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
    // --- 1. CANLI ARAMA SÄ°STEMÄ° ---
    const isimInput = document.getElementById('isim');
    const resultsDiv = document.getElementById('search-results');
    const gramContainer = document.getElementById('gram-container');
    const gramInput = document.getElementById('gram');
    let debounceTimer;

    isimInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value;
        
        if(query.length < 2) { resultsDiv.style.display = 'none'; return; }

        debounceTimer = setTimeout(() => {
            fetch(`/search_food_api?q=${query}`)
                .then(res => res.json())
                .then(data => {
                    resultsDiv.innerHTML = '';
                    if(data.length > 0) {
                        data.forEach(item => {
                            const a = document.createElement('a');
                            a.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary';
                            a.style.cursor = 'pointer';
                            // Listede nasÄ±l gÃ¶rÃ¼neceÄŸi
                            a.innerHTML = `<strong>${item.name}</strong> <small class="text-muted">(${item.cal} kcal/100g)</small>`;
                            
                            // TÄ±klayÄ±nca ne olsun?
                            a.onclick = () => {
                                selectFood(item);
                            };
                            resultsDiv.appendChild(a);
                        });
                        resultsDiv.style.display = 'block';
                    } else {
                        resultsDiv.style.display = 'none';
                    }
                });
        }, 500); // 0.5 saniye bekle (Sunucuyu yorma)
    });

    // Yemek SeÃ§ilince
    function selectFood(item) {
        isimInput.value = item.name;
        resultsDiv.style.display = 'none';
        
        // 100g deÄŸerlerini referans olarak sakla
        document.getElementById('ref_cal').value = item.cal;
        document.getElementById('ref_pro').value = item.pro;
        document.getElementById('ref_carb').value = item.carb;
        document.getElementById('ref_fat').value = item.fat;

        // Gramaj kutusunu aÃ§ ve hesapla (VarsayÄ±lan 100g)
        gramContainer.style.display = 'flex';
        gramInput.value = 100;
        calculateMacros(100);
    }

    // Gramaj DeÄŸiÅŸince Hesapla
    gramInput.addEventListener('input', function() {
        calculateMacros(this.value);
    });

    function calculateMacros(grams) {
        const ratio = grams / 100;
        document.getElementById('kalori').value = Math.round(document.getElementById('ref_cal').value * ratio);
        document.getElementById('protein').value = Math.round(document.getElementById('ref_pro').value * ratio);
        document.getElementById('carbs').value = Math.round(document.getElementById('ref_carb').value * ratio);
        document.getElementById('fat').value = Math.round(document.getElementById('ref_fat').value * ratio);
    }

    // --- 2. BARKOD SÄ°STEMÄ° (Ã–ncekiyle AynÄ±) ---
    const scanButton = document.getElementById('btn-scan');
    const container = document.getElementById('reader-container');
    const previewElement = document.getElementById('reader');

    scanButton.onclick = () => {
        container.style.display = 'block';
        Quagga.init({
            inputStream : { name : "Live", type : "LiveStream", target: previewElement, 
                constraints: { facingMode: "environment", width: 640, height: 480, aspectRatio: {min: 1, max: 2}} },
            decoder : { readers : ["ean_reader"] },
            locate: true
        }, function(err) { if (!err) Quagga.start(); });
    };

    Quagga.onDetected(function(result) {
        var code = result.codeResult.code;
        if (code && code.length > 7) {
            fetch(`/get_barcode_data?code=${code}`).then(res => res.json()).then(data => {
                if(data.found) {
                    selectFood({name: data.name, cal: data.calories, pro: data.protein, carb: data.carbs, fat: data.fat});
                    Quagga.stop(); container.style.display = 'none';
                } else { alert("BulunamadÄ±."); Quagga.stop(); container.style.display = 'none'; }
            });
        }
    });
    
    document.getElementById('btn-stop').onclick = () => { Quagga.stop(); container.style.display = 'none'; };
</script>
{% endblock %}