{% extends "layout.html" %}

{% block content %}
<div class="row mb-3">
    <div class="col-6">
        <div class="card text-center p-2">
            <small class="text-muted">Toplam Kalori</small>
            <h3 class="text-warning mb-0">{{ total_cal }}</h3>
        </div>
    </div>
    <div class="col-6">
        <div class="card text-center p-2">
            <small class="text-muted">Toplam Protein</small>
            <h3 class="text-info mb-0">{{ total_pro }}g</h3>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>üçΩÔ∏è YEMEK EKLE</span>
        <button id="btn-scan" class="btn btn-sm btn-outline-warning">
            <i class="fas fa-camera"></i> Barkod Oku
        </button>
    </div>
    <div class="card-body">
        
        <div id="reader-container" class="mb-3" style="display:none;">
            <div id="reader" style="width: 100%;"></div>
            <button id="btn-stop" class="btn btn-danger w-100 mt-2">Kamerayƒ± Kapat</button>
        </div>

        <form method="POST">
            <input type="hidden" name="yemek_ekle" value="1">
            
            <div class="input-group mb-2">
                <span class="input-group-text bg-dark text-white border-secondary"><i class="fas fa-barcode"></i></span>
                <input type="text" id="barcode" name="barcode" class="form-control" placeholder="Barkod No (Varsa)">
            </div>

            <div class="mb-2">
                <input type="text" id="isim" name="isim" class="form-control" placeholder="Yemek Adƒ± (√ñrn: Muz)" required>
            </div>
            
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <input type="number" id="kalori" name="kalori" class="form-control" placeholder="Kalori">
                </div>
                <div class="col-6">
                    <input type="number" id="protein" name="protein" class="form-control" placeholder="Protein (g)">
                </div>
            </div>

            <button type="submit" class="btn btn-success w-100">Listeye Ekle</button>
        </form>
    </div>
</div>

<div class="card mt-4">
    <ul class="list-group list-group-flush">
        {% for meal in meals %}
        <li class="list-group-item bg-transparent text-white border-secondary d-flex justify-content-between align-items-center">
            <div>
                <strong>{{ meal.isim }}</strong>
                <br>
                <small class="text-muted">{{ meal.kalori }} kcal | {{ meal.protein }}g Prot</small>
            </div>
            <form method="POST" style="display:inline;">
                <input type="hidden" name="yemek_sil" value="1">
                <input type="hidden" name="yemek_id" value="{{ meal.id }}">
                <button class="btn btn-sm btn-outline-danger border-0"><i class="fas fa-trash"></i></button>
            </form>
        </li>
        {% endfor %}
    </ul>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    const html5QrCode = new Html5Qrcode("reader");
    const scanButton = document.getElementById('btn-scan');
    const stopButton = document.getElementById('btn-stop');
    const container = document.getElementById('reader-container');

    // Ba≈üarƒ±lƒ± Okuma
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        try { window.navigator.vibrate(200); } catch(e){}

        document.getElementById('barcode').value = decodedText;
        stopCamera(); // Okur okumaz durdur

        // Backend Sorgusu
        fetch(`/get_barcode_data?code=${decodedText}`)
            .then(response => response.json())
            .then(data => {
                if(data.found) {
                    document.getElementById('isim').value = data.name;
                    document.getElementById('kalori').value = data.calories;
                    document.getElementById('protein').value = data.protein;
                    alert("‚úÖ Bulundu: " + data.name);
                } else {
                    alert("‚ö†Ô∏è √úr√ºn yok. Elle girip kaydederseniz hafƒ±zaya alƒ±rƒ±m.");
                }
            })
            .catch(err => alert("Hata: " + err));
    };

    // --- KRƒ∞Tƒ∞K AYARLAR ---
    const config = { 
        fps: 10, 
        // Tarama alanƒ±nƒ± ƒ∞NCE UZUN Dƒ∞KD√ñRTGEN yaptƒ±k (Barkod ≈üekli)
        qrbox: { width: 300, height: 100 }, 
        aspectRatio: 1.0,
        // ƒ∞≈ûTE EKSƒ∞K OLAN KISIM BURASIYDI üëá
        formatsToSupport: [ 
            Html5QrcodeSupportedFormats.EAN_13, // Standart Market Barkodu
            Html5QrcodeSupportedFormats.EAN_8,  // K√º√ß√ºk Paketler
            Html5QrcodeSupportedFormats.UPC_A   // ƒ∞thal √úr√ºnler
        ]
    };

    // Ba≈ülat
    scanButton.onclick = () => {
        container.style.display = 'block';
        
        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            qrCodeSuccessCallback
        ).catch(err => {
            console.error(err);
            container.style.display = 'none';
            alert("Kamera Hatasƒ±: " + err);
        });
    };

    function stopCamera() {
        html5QrCode.stop().then(() => {
            container.style.display = 'none';
        }).catch(err => console.log(err));
    }
    stopButton.onclick = stopCamera;

    // Manuel Giri≈ü
    document.getElementById('barcode').addEventListener('change', function() {
        let code = this.value;
        if(code.length > 3) {
             fetch(`/get_barcode_data?code=${code}`)
            .then(response => response.json())
            .then(data => {
                if(data.found) {
                    document.getElementById('isim').value = data.name;
                    document.getElementById('kalori').value = data.calories;
                    document.getElementById('protein').value = data.protein;
                }
            });
        }
    });
</script>
{% endblock %}